# Example SD-MUX based board configuration
# This template shows how to use the SDMuxStrategy for boards that boot from SD card
#
# Hardware Requirements:
#   - USB-SD-MUX hardware (https://www.linux-automation.com/en/products/usb-sd-mux.html)
#   - Serial console access
#   - Power control (e.g., Tasmota, NetworkPowerPort)
#
# The RemotePlace should include:
#   - NetworkUSBSDMuxDevice (SD card mux control)
#   - NetworkSerialPort (serial console)
#   - NetworkPowerPort (power control)
#
# Usage:
#   # Write image and boot (uses default image set)
#   barebox-bringup -c examples/arm/sdmux-example.yaml
#
#   # Use known-good image set
#   barebox-bringup -c examples/arm/sdmux-example.yaml --images known_good
#
#   # Boot from existing SD card (skip writing)
#   barebox-bringup -c examples/arm/sdmux-example.yaml --no-write
#
#   # Override image
#   barebox-bringup -c examples/arm/sdmux-example.yaml --image /path/to/custom-barebox.img

targets:
  main:
    resources:
      RemotePlace:
        name: my-sdmux-board  # Replace with your actual place name
    drivers:
      # Power driver (for power cycling)
      - TasmotaPowerDriver: {}
      # Or use NetworkPowerDriver, PDUDaemonDriver, etc.

      # Serial console driver
      - SerialDriver:
          txdelay: 0.01

      # SD-MUX driver (controls SD card routing)
      - USBSDMuxDriver: {}

      # USB Storage driver (writes images to SD card)
      - USBStorageDriver: {}

      # Barebox driver (for interacting with barebox shell)
      - BareboxDriver:
          prompt: 'barebox@[^:]+:[^ ]+ '
          bootstring: 'commandline:'

      # SD-MUX Strategy (orchestrates the boot process)
      - SDMuxStrategy: {}

image-sets:
  # Default image set (used if no --images specified)
  default:
    # Simple format: just image path
    barebox.img: !template "$LG_BUILDDIR/images/barebox-my-board.img"

  # Known-good image set (use with --images known_good)
  known_good:
    barebox.img: "/path/to/validated/barebox.img"

  # Example with seek offset (use with --images rockchip)
  # Some boards (e.g., Rockchip) require images to be written at an offset
  rockchip:
    barebox.img:
      image: !template "$LG_BUILDDIR/images/barebox-rock5t.img"
      seek: 64  # Write at 64 * 512 = 32KB offset (dd seek=N)

  # Example with skip (skipping input blocks)
  # skip_header:
  #   barebox.img:
  #     image: !template "$LG_BUILDDIR/images/barebox-with-header.img"
  #     skip: 1  # Skip first 512 bytes of input (dd skip=N)

imports:
  - ../strategy-sdmux.py

options:
  coordinator_address: lg-coordinator:20408  # Adjust for your lab
  # proxy: "127.0.0.1:8888"  # Optional proxy
